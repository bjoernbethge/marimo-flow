name: Claude Code with MCP Integration

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize]

jobs:
  claude:
    # Trigger on @claude mentions or new PRs
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      github.event_name == 'pull_request'

    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Dependencies
        run: |
          # Install core dependencies with MCP support
          uv pip install --system "marimo[mcp]>=0.18.0"
          uv pip install --system "mlflow[mcp]>=2.19.0"

          # Install project dependencies
          uv sync --no-dev

      - name: Setup MLflow Backend
        run: |
          # Create MLflow directories
          mkdir -p data/mlflow/{db,artifacts}

          # Initialize SQLite database if needed
          if [ ! -f data/mlflow/db/mlflow.db ]; then
            echo "Initializing MLflow database..."
            touch data/mlflow/db/mlflow.db
          fi

          # Start MLflow server in background
          mlflow server \
            --host 0.0.0.0 \
            --port 5000 \
            --backend-store-uri sqlite:///$(pwd)/data/mlflow/db/mlflow.db \
            --default-artifact-root $(pwd)/data/mlflow/artifacts \
            --serve-artifacts &

          # Wait for MLflow to be ready
          echo "Waiting for MLflow server..."
          for i in {1..30}; do
            if curl -s http://localhost:5000/health > /dev/null 2>&1; then
              echo "✅ MLflow server ready!"
              break
            fi
            sleep 1
          done

      - name: Start Marimo MCP Server
        run: |
          # Start Marimo with MCP support (headless mode for CI)
          marimo edit examples/ \
            --mcp \
            --no-token \
            --headless \
            --host 0.0.0.0 \
            --port 2718 &

          # Wait for Marimo MCP server to be ready
          echo "Waiting for Marimo MCP server..."
          for i in {1..30}; do
            if curl -s http://localhost:2718/mcp/server > /dev/null 2>&1; then
              echo "✅ Marimo MCP server ready!"
              break
            fi
            sleep 1
          done

      - name: Start MLflow MCP Server
        run: |
          # Start MLflow MCP server in background
          export MLFLOW_TRACKING_URI=http://localhost:5000
          mlflow mcp run &

          # Give it a moment to initialize
          sleep 3
          echo "✅ MLflow MCP server started!"

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # MCP Server Configuration
          # 1. marimo: Notebook introspection and cell analysis
          # 2. context7: Live documentation for Python libraries
          # 3. mlflow: Experiment tracking and model management
          mcp_servers: |
            [
              {
                "name": "marimo",
                "transport": "http",
                "url": "http://localhost:2718/mcp/server"
              },
              {
                "name": "context7",
                "transport": "sse",
                "url": "https://context7.com/api/v1/mcp/sse"
              },
              {
                "name": "mlflow",
                "transport": "stdio",
                "command": "mlflow",
                "args": ["mcp", "run"],
                "env": {
                  "MLFLOW_TRACKING_URI": "http://localhost:5000"
                }
              }
            ]

          # Allowed Tools - All MCP tools + standard Claude Code tools
          allowed_tools: |
            mcp__marimo__get_active_notebooks
            mcp__marimo__get_notebook_errors
            mcp__marimo__get_cell_runtime_data
            mcp__marimo__get_tables_and_variables
            mcp__marimo__get_database_tables
            mcp__marimo__get_lightweight_cell_map
            mcp__marimo__get_marimo_rules
            mcp__context7__search_docs
            mcp__context7__get_library_docs
            mcp__mlflow__search_experiments
            mcp__mlflow__get_experiment
            mcp__mlflow__search_runs
            mcp__mlflow__get_run
            mcp__mlflow__log_metric
            mcp__mlflow__log_param
            mcp__mlflow__list_models
            mcp__mlflow__get_model_version
            Edit
            Read
            Write
            Bash
            Glob
            Grep
            WebSearch

          # Custom Instructions for marimo-flow
          custom_instructions: |
            You are working in the **marimo-flow** repository - an AI-first ML development environment.

            ## Project Context
            - **Marimo**: Reactive Python notebooks (`.py` files, git-friendly)
            - **MLflow**: ML experiment tracking and model registry
            - **PINA**: Physics-Informed Neural Networks
            - **Stack**: Polars (data), Altair/Plotly (viz), DuckDB (analytics)

            ## MCP Tools Available

            ### Marimo MCP (Notebook Introspection)
            - `get_active_notebooks`: List all open notebooks
            - `get_notebook_errors`: Find runtime errors in cells
            - `get_cell_runtime_data`: Inspect cell execution state
            - `get_tables_and_variables`: Analyze DataFrames and variables
            - `get_database_tables`: Inspect DuckDB/SQL connections

            ### Context7 MCP (Live Documentation)
            - `search_docs`: Find docs for any Python library
            - `get_library_docs`: Get comprehensive library reference
            - Use for: Polars, Plotly, Altair, Marimo, scikit-learn, PyTorch

            ### MLflow MCP (Experiment Tracking)
            - `search_experiments`: Find ML experiments
            - `search_runs`: Query training runs
            - `log_metric/log_param`: Track experiments
            - `list_models`: Browse model registry

            ## Workflow Guidelines

            ### When Analyzing Notebooks
            1. Use `get_active_notebooks` to find which notebooks are running
            2. Use `get_notebook_errors` to diagnose issues
            3. Use `get_tables_and_variables` for data schema inspection
            4. Check `examples/` directory for notebook source code

            ### When Working with Data
            - **Prefer Polars** over Pandas for performance
            - Use Context7 to get latest Polars patterns
            - Leverage DuckDB for SQL analytics
            - Check `snippets/data_explorer_pattern.py` for reusable patterns

            ### When Working with ML
            - Check MLflow experiments before creating new ones
            - Log all hyperparameters and metrics to MLflow
            - Follow patterns in `examples/04_hyperparameter_tuning.py`
            - Use `snippets/pina_basics.py` for PINA workflows

            ### When Creating Visualizations
            - **Altair** for declarative charts (see `snippets/altair_visualization.py`)
            - **Plotly** for 3D plots and complex interactions
            - Follow patterns in `examples/tutorials/`

            ### Code Standards
            - Marimo cells must be idempotent (no hidden state)
            - Use unique variable names to avoid conflicts
            - Include type hints for all functions
            - Use NumPy-style docstrings
            - Format with Black (line length 79 for local, 88 for docker)

            ### Directory Structure
            - `examples/`: Production notebooks (01-09 + tutorials/)
            - `snippets/`: Reusable modules for import
            - `data/mlflow/`: Experiment tracking storage
            - `docs/`: Reference documentation

            ## Common Tasks

            **Notebook Debugging**: Use Marimo MCP to find errors, then read the source
            **Performance Optimization**: Check table schemas, suggest Polars lazy evaluation
            **ML Experiment Review**: Query MLflow for metrics, compare runs
            **Documentation Lookup**: Use Context7 instead of asking user to check docs

            Remember: This is a reactive environment. Changes to one cell cascade through
            the dependency graph. Always consider reactivity when modifying notebooks.

      - name: Verify Services Running
        if: failure()
        run: |
          echo "=== Service Status ==="
          echo "MLflow:"
          curl -f http://localhost:5000/health || echo "❌ MLflow not responding"
          echo ""
          echo "Marimo MCP:"
          curl -f http://localhost:2718/mcp/server || echo "❌ Marimo MCP not responding"
          echo ""
          echo "=== Logs ==="
          jobs -l
          ps aux | grep -E "mlflow|marimo"
