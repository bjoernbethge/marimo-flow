services:
  marimo-flow:
    image: ghcr.io/bjoernbethge/marimo-flow:xpu
    build:
      context: ..
      dockerfile: docker/Dockerfile.xpu
    container_name: marimo-flow-xpu
    ports:
      - "2718:2718" # Marimo UI
      - "5000:5000" # MLflow backend
    volumes:
      - ../data:/app/data
      - ../examples:/app/examples
      - ../snippets:/app/snippets
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "localhost:host-gateway"
      - "marimo-flow:127.0.0.1"
    environment:
      - MLFLOW_BACKEND_STORE_URI=sqlite:////app/data/experiments/db/mlflow.db
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=/app/data/experiments/artifacts
      - MLFLOW_SERVE_ARTIFACTS=true
      - MLFLOW_HOST=0.0.0.0
      - MLFLOW_PORT=5000
      - MLFLOW_TRACKING_USERNAME=
      - MLFLOW_TRACKING_PASSWORD=
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Intel GPU device passthrough
    devices:
      - /dev/dri:/dev/dri
    group_add:
      - render
      - video

volumes: {}
